@page "/"
@using System.Numerics
@using System.Drawing
@using BugViewer
@using TVGL
@using TVGLPresenter.Components

<PageTitle>Home</PageTitle>

<div style="display: flex; flex-direction: column; height: 100vh;">
    <div style="padding: 10px;">
        <InputFile OnChange="OpenFile" />
    </div>
    
    <div style="flex: 1; min-height: 0; position: relative;">
        <BugViewer @ref="viewer" Height="30%" Width="80%" />
    </div>
    
    <div style="height: 200px; overflow: auto;">
        <LogViewer @ref="logViewer" />
    </div>
</div>

@code {
	private BugViewer? viewer;
	private LogViewer logViewer = new()!;

	protected override void OnAfterRender(bool firstRender)
	{
		if (firstRender)
		{
			TVGL.Global.Logger = logViewer;
		}
	}
	private async Task OpenFile(InputFileChangeEventArgs args)
	{
		var fileArgs = args.GetMultipleFiles(1)[0];
		string filename = fileArgs.Name;
		logViewer.LogInformation($"Loaded polygon from {filename}");

		// Buffer the file into a MemoryStream to allow synchronous reads.
		await using var memoryStream = new MemoryStream();
		// The OpenReadStream provides a stream that must be read asynchronously.
		await using (var stream = fileArgs.OpenReadStream(long.MaxValue))
		{
			await stream.CopyToAsync(memoryStream);
		}
		// Reset the Center to the beginning of the stream.
		memoryStream.Position = 0;
		TessellatedSolid[] solids = null;
		try
		{
			IO.Open(memoryStream, filename, out solids);
		}
		catch (Exception ex)
		{ logViewer.LogError(ex, "opening file with TVGL"); }
		if (solids == null || solids.Length == 0)
		{
			logViewer.LogError("Unable to load file.");
			return;
		}
		var ts = solids[0];
		MeshData meshData;
		meshData = new MeshData
		{
			ColorMode = ts.HasUniformColor ? MeshColoring.UniformColor : MeshColoring.PerTriangle,
			Id = Path.GetFileName(filename),
			Colors = ts.HasUniformColor ? [ConvertFromTVGLColor(ts.SolidColor)]
			: ts.Faces.Select(f => ConvertFromTVGLColor(f.Color)),
			Indices = ts.Faces.Select(f => (f.A.IndexInList, f.B.IndexInList, f.C.IndexInList)),
			Vertices = ts.Vertices.Select(v => new System.Numerics.Vector3((float)v.X, (float)v.Y, (float)v.Z))
		};
		// Add to WebGPU scene
		await viewer.AddMeshAsync(meshData);
	}

	private static System.Drawing.Color ConvertFromTVGLColor(TVGL.Color c)
	{
		if (c == null)
			c = new TVGL.Color(TVGL.Constants.DefaultColor);
		return System.Drawing.Color.FromArgb(c.A, c.R, c.G, c.B);
	}
}