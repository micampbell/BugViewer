@using Microsoft.FluentUI.AspNetCore.Components

<div class="options-panel-container @(IsExpanded ? "expanded" : "collapsed")">
    <FluentButton OnClick="ToggleExpanded"
                  Appearance="Appearance.Stealth"
                  Class="toggle-btn">
        @(IsExpanded ? "⚙️ Viewer Settings ▼" : "⚙️")
    </FluentButton>

    @if (IsExpanded)
    {
        <div class="options-content">
            <FluentAccordion>
                <FluentAccordionItem Heading="Lighting">
                    <!-- Use a single column so the picker can consume the panel width -->
                    <FluentStack Orientation="Orientation.Vertical" Style="width:100%;">
                        <label>Clear Color (Sky)</label>
                        <input type="color" style="width:100%; max-width:100%;" @bind="Options.ClearColor" @bind:event="oninput" />
                    </FluentStack>
                    <FluentSlider Label="Light Polar Angle" @bind-Value="Options.LightPolarAngle" Min="0" Max="3.14" Step="0.01" />
                    <FluentSlider Label="Light Azimuthal" @bind-Value="Options.LightAzimuthAngle" Min="1" Max="6.28" Step="0.01" />
                    <FluentSlider Label="Ambient Light Factor" @bind-Value="Options.AmbientLight" Min="0" Max="1" Step="0.01" />
                    <FluentSlider Label="SpecularPower" @bind-Value="Options.SpecularPower" Min="1" Max="100" Step="0.25" />
                </FluentAccordionItem>
            </FluentAccordion>

            <FluentAccordion>
                <FluentAccordionItem Heading="📐 Grid">
                    <FluentStack Orientation="Orientation.Vertical">
                        <FluentSlider Label="Coordinate Thickness" @bind-Value="Options.CoordinateThickness" Min="0" Max="10" Step="0.1" />
                        <FluentSlider Label="Grid Size" @bind-Value="Options.GridSize" Min="50" Max="1000" Step="1" />
                        <FluentSlider Label="Grid Spacing" @bind-Value="Options.GridSpacing" Min="1" Max="100" Step="0.5" />
                        <FluentSlider Label="Line Width X" @bind-Value="Options.LineWidthX" Min="0" Max="1" Step="0.01" />
                        <FluentSlider Label="Line Width Y" @bind-Value="Options.LineWidthY" Min="0" Max="1" Step="0.01" />

                        <label>Grid Line Color</label>
                        <input type="color" style="width:100%; max-width:100%;" @bind="Options.LineColor" @bind:event="oninput" />
                        <FluentSlider Label="Line Transparency" @bind-Value="Options.LineTransparency" Min="0" Max="1" Step="0.01" />

                        <label>Grid Base Color</label>
                        <input type="color" style="width:100%; max-width:100%;" @bind="Options.BaseColor" @bind:event="oninput" />
                        <FluentSlider Label="Base Transparency" @bind-Value="Options.BaseTransparency" Min="0" Max="1" Step="0.01" />
                    </FluentStack>
                </FluentAccordionItem>
            </FluentAccordion>

            <FluentAccordion>
                <FluentAccordionItem Heading="📷 Camera">
                    <FluentStack Orientation="Orientation.Vertical">
                        <FluentSwitch Label="Which Coordinate is Up?" CheckedMessage="Z is Up" UncheckedMessage="Y is Up" @bind-Value="Options.ZIsUp" />
                        <FluentSwitch Label="Is View Projectsion or Orthographic?" CheckedMessage="Projection" UncheckedMessage="Orthographic" @bind-Value="Options.IsProjectionCamera" />

                        @if (Options.IsProjectionCamera)
                        {
                            <FluentSlider Label="Field of View" @bind-Value="Options.Fov" Min="1" Max="179" Step="0.5" />
                            <FluentLabel>Controls perspective distortion</FluentLabel>
                        }
                        else
                        {
                            <FluentLabel>Orthographic Size: @Options.OrthoSize.ToString("F2")</FluentLabel>
                            <FluentSlider @bind-Value="Options.OrthoSize" Min="1" Max="999" Step="0.5" />
                            <FluentLabel>Half-height of visible area</FluentLabel>
                        }

                        <FluentLabel>Near Clipping Plane: @Options.ZNear.ToString("F5")</FluentLabel>
                        <FluentSlider @bind-Value="Options.ZNear" Min="0.00001" Max="1" Step="0.001" />

                        <FluentLabel>Far Clipping Plane: @Options.ZFar.ToString("F0")</FluentLabel>
                        <FluentSlider @bind-Value="Options.ZFar" Min="10" Max="9999" Step="1" />

                        <FluentLabel Typo="Typography.H6">Orbit Constraints</FluentLabel>
                        <FluentCheckbox @bind-Value="Options.ConstrainPolar" Label="Constrain Polar Angle" />

                        @if (Options.ConstrainPolar)
                        {
                            <FluentLabel>Max Polar Angle: @((Options.MaxPolar * 180 / Math.PI).ToString("F0"))°</FluentLabel>
                            <FluentSlider @bind-Value="Options.MaxPolar" Min="0" Max="@(Math.PI * 0.5)" Step="0.01" />
                            <FluentLabel>Min Polar Angle: @((Options.MinPolar * 180 / Math.PI).ToString("F0"))°</FluentLabel>
                            <FluentSlider @bind-Value="Options.MinPolar" Min="@(-Math.PI * 0.5)" Max="0" Step="0.01" />
                        }

                        <FluentCheckbox @bind-Value="Options.ConstrainAzimuth" Label="Constrain Azimuth Angle" />

                        @if (Options.ConstrainAzimuth)
                        {
                            <FluentLabel>Max Azimuth Angle: @((Options.MaxAzimuth * 180 / Math.PI).ToString("F0"))°</FluentLabel>
                            <FluentSlider @bind-Value="Options.MaxAzimuth" Min="@(-Math.PI)" Max="@Math.PI" Step="0.01" />
                            <FluentLabel>Min Azimuth Angle: @((Options.MinAzimuth * 180 / Math.PI).ToString("F0"))°</FluentLabel>
                            <FluentSlider @bind-Value="Options.MinAzimuth" Min="@(-Math.PI)" Max="@Math.PI" Step="0.01" />
                        }

                        <FluentLabel Typo="Typography.H6">Distance Constraints</FluentLabel>
                        <FluentCheckbox @bind-Value="Options.ConstrainDistance" Label="Constrain Distance" />

                        @if (Options.ConstrainDistance)
                        {
                            <FluentLabel>Max Distance: @Options.MaxDistance.ToString("F1")</FluentLabel>
                            <FluentSlider @bind-Value="Options.MaxDistance" Min="1" Max="1000" Step="0.5" />
                            <FluentLabel>Min Distance: @Options.MinDistance.ToString("F2")</FluentLabel>
                            <FluentSlider @bind-Value="Options.MinDistance" Min="0.1" Max="10" Step="0.1" />
                        }

                        <FluentLabel Typo="Typography.H6">Sensitivity Settings</FluentLabel>
                        <FluentLabel>Orbit Sensitivity: @Options.OrbitSensitivity.ToString("F5")</FluentLabel>
                        <FluentSlider @bind-Value="Options.OrbitSensitivity" Min="0.001" Max="0.1" Step="0.001" />
                        <FluentLabel>Zoom Sensitivity: @Options.ZoomSensitivity.ToString("F5")</FluentLabel>
                        <FluentSlider @bind-Value="Options.ZoomSensitivity" Min="0.0001" Max="0.01" Step="0.0001" />
                        <FluentLabel>Pan Sensitivity: @Options.PanSensitivity.ToString("F5")</FluentLabel>
                        <FluentSlider @bind-Value="Options.PanSensitivity" Min="0.0001" Max="0.01" Step="0.001" />
                        <FluentLabel>Pan Speed Multiplier (Shift): @Options.PanSpeedMultiplier.ToString("F1")</FluentLabel>
                        <FluentSlider @bind-Value="Options.PanSpeedMultiplier" Min="1" Max="10" Step="0.5" />
                    </FluentStack>
                </FluentAccordionItem>
            </FluentAccordion>

            <FluentAccordion>
                <FluentAccordionItem Heading="🎬 Rendering">
                    <FluentStack Orientation="Orientation.Vertical">
                        <FluentSelect @bind-Value="@SampleCountString" Label="MSAA Sample Count" Items="_sampleCountItems" />
                        <FluentLabel>⚠️ Requires page refresh to take effect</FluentLabel>

                        @if (_showMsaaRefreshPrompt)
                        {
                            <div class="refresh-prompt">
                                <FluentLabel Typo="Typography.Body">MSAA setting changed</FluentLabel>
                                <FluentButton OnClick="RefreshPage" Appearance="Appearance.Accent" Class="refresh-btn">Refresh Page Now</FluentButton>
                            </div>
                        }

                        <FluentButton OnClick="ResetToDefaults" Appearance="Appearance.Outline" Style="width: 100%;">Reset to Defaults</FluentButton>
                    </FluentStack>
                </FluentAccordionItem>
            </FluentAccordion>
        </div>
    }
</div>

<style>
    .options-panel-container {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(30, 30, 30, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
        z-index: 1000;
        max-height: 90vh;
        overflow: hidden;
        transition: width 0.3s ease;
        display: inline-block; /* shrink to fit */
    }

        .options-panel-container.collapsed {
            width: auto;
        }

        .options-panel-container.expanded {
            width: fit-content; /* content-driven */
            max-width: 300px; /* cap width */
            min-width: 150px; /* keep usable */
        }

    .options-content {
        width: 100%;
        padding: 0 12px 12px;
        max-height: calc(90vh - 60px);
        overflow-y: auto;
        box-sizing: border-box;
    }

    /* If you reintroduce a color grid, keep it from forcing width */
    .colors-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    @@media (max-width: 500px) {
        .options-panel-container.expanded {
            width: clamp(240px, 85vw, 380px);
        }

        .colors-grid {
            grid-template-columns: 1fr;
        }
    }

    .refresh-prompt {
        margin-top: 16px;
        padding: 12px;
        background: rgba(255, 193, 7, 0.15);
        border: 1px solid #ffc107;
        border-radius: 8px;
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
</style>

@code {
    [Parameter] public BugViewerOptions Options { get; set; }
    [Parameter] public bool IsExpanded { get; set; } = true;
    [Parameter] public EventCallback<bool> IsExpandedChanged { get; set; }
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private bool _showMsaaRefreshPrompt = false;
    private string SampleCountString
    {
        get => Options.SampleCount.ToString();
        set
        {
            if (int.TryParse(value, out var v)) 
            Options.SampleCount = v;
        }
    }
    private List<Option<string>> _sampleCountItems = new()
    {
        new() { Value = "1", Text = "1x - No anti-aliasing (fastest)" },
        new() { Value = "2", Text = "2x - Slight smoothing" },
        new() { Value = "4", Text = "4x - Smooth (recommended)" },
        new() { Value = "8", Text = "8x - Very smooth (slower)" }
    };

    protected override void OnInitialized()
    {
        Options.PropertyChanged += OnOptionsPropertyChanged;
    }

    private void OnOptionsPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        if (e.PropertyName == nameof(BugViewerOptions.SampleCount))
        {
            _showMsaaRefreshPrompt = true;
            StateHasChanged();
        }
    }

    private async Task ToggleExpanded()
    {
        IsExpanded = !IsExpanded;
        await IsExpandedChanged.InvokeAsync(IsExpanded);
    }

    private void RefreshPage() => Navigation.NavigateTo(Navigation.Uri, true);

    private void ResetToDefaults()
    {
        Options.ResetToDefault();
        _showMsaaRefreshPrompt = false;
    }
}
