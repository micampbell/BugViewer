@using System.Numerics
@using System.Drawing
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using Microsoft.FluentUI.AspNetCore.Components
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size24
@inject IJSRuntime JS
@implements IAsyncDisposable

<div @ref="_containerRef" tabindex="0" @onkeydown="OnKeyDown" @onkeyup="OnKeyUp" @onkeydown:stopPropagation="true" class="page-container" style="width:@Width; height:@Height; position:relative;" @onmousedown="() => _isMouseButtonDown = true" @onmouseup="() => _isMouseButtonDown = false" @onmouseleave="() => _isMouseButtonDown = false">
    <canvas id="webgpu-canvas"
            class="webgpu-canvas"
            style="height:100%; width:100%;"
            @ref="_canvasRef"
            @onpointerdown="OnPointerDown"
            @onpointermove="OnPointerMove"
            @onpointerup="OnPointerUp"
            @onwheel="OnWheel"
            @onwheel:preventDefault="true"
            @oncontextmenu:preventDefault="true">
    </canvas>
    <!-- A small anchor button to toggle the popover -->
    <FluentStack Style="position:absolute; top:4px; left:4px; z-index:1001"
                 Class="@($"toolbar-buttons {(_isMouseButtonDown ? "mouse-down" : "")} {(IsAnyPopoverOpen ? "popover-open" : "")}")">
        <FluentButton Id="options"
                      Appearance="Appearance.Stealth"
                      Title="Open Options"
                      OnClick="@(() => ShowOptionsPanel())">
            <FluentIcon Value="@(new Icons.Settings())" />
        </FluentButton>
        <FluentButton Id="camera-controls"
                      Appearance="Appearance.Stealth"
                      Title="Open Camera Controls"
                      OnClick="@(() => ShowCameraPanel())">
            <FluentIcon Value="@(new Icons.CameraSparkles())" />
        </FluentButton>
        <FluentButton Id="help"
                      Appearance="Appearance.Stealth"
                      Title="Open Help"
                      OnClick="@(() => ShowHelpPanel())">
            <FluentIcon Value="@(new Icons.Question())" />
        </FluentButton>
    </FluentStack>

    <FluentPopover AnchorId="camera-controls"
                   Style="width:50px;"
                   @bind-Open="_cameraPopover"
                   HorizontalPosition="HorizontalPosition.Right">
        <Body>
            <FluentStack Orientation="Orientation.Vertical">
                <FluentButton OnClick="HandleCameraReset" Appearance="Appearance.Stealth" Title="Reset Camera" Class="toolbar-btn reset-btn"><FluentIcon Value="@(new Icons.CameraSwitch())" /></FluentButton>
                <FluentButton OnClick="@(() => HandleCameraCardinalView(CardinalDirection.NegativeX))" Appearance="Appearance.Stealth" Title="View -X" Class="toolbar-btn cardinal-btn">-X</FluentButton>
                <FluentButton OnClick="@(() => HandleCameraCardinalView(CardinalDirection.PositiveX))" Appearance="Appearance.Stealth" Title="View +X" Class="toolbar-btn cardinal-btn">+X</FluentButton>
                <FluentButton OnClick="@(() => HandleCameraCardinalView(CardinalDirection.NegativeY))" Appearance="Appearance.Stealth" Title="View -Y" Class="toolbar-btn cardinal-btn">-Y</FluentButton>
                <FluentButton OnClick="@(() => HandleCameraCardinalView(CardinalDirection.PositiveY))" Appearance="Appearance.Stealth" Title="View +Y" Class="toolbar-btn cardinal-btn">+Y</FluentButton>
                <FluentButton OnClick="@(() => HandleCameraCardinalView(CardinalDirection.NegativeZ))" Appearance="Appearance.Stealth" Title="View -Z" Class="toolbar-btn cardinal-btn">-Z</FluentButton>
                <FluentButton OnClick="@(() => HandleCameraCardinalView(CardinalDirection.PositiveZ))" Appearance="Appearance.Stealth" Title="View +Z" Class="toolbar-btn cardinal-btn">+Z</FluentButton>
            </FluentStack>
        </Body>
    </FluentPopover>
    <FluentPopover AnchorId="options"
                   Style="width:360px;"
                   @bind-Open="_optionsPopover"
                   HorizontalPosition="HorizontalPosition.Right">
        <Body>
            <div style="max-height:70vh; overflow-y: auto;">
                <FluentStack Orientation="Orientation.Vertical">
                    <FluentAccordion>
                        <FluentAccordionItem Heading="Lighting">
                            <FluentRadioGroup @bind-Value="Options.IsDarkTheme">
                                <FluentRadio Value="false">Light</FluentRadio>
                                <FluentRadio Value="true">Dark</FluentRadio>
                            </FluentRadioGroup>
                            <FluentLabel>Color Theme</FluentLabel>
                            <FluentStack Orientation="Orientation.Vertical" Style="width:100%;">
                                <label>Clear Color</label>
                                <input type="color" style="width:100%;" @bind="Options.ClearColor" @bind:event="oninput" />
                            </FluentStack>
                            <FluentSlider Label="Light Polar Angle" @bind-Value="Options.LightPolarAngle" Min="0" Max="3.14" Step="0.01" />
                            <FluentSlider Label="Light Azimuthal" @bind-Value="Options.LightAzimuthAngle" Min="1" Max="6.28" Step="0.01" />
                            <FluentSlider Label="Ambient Light" @bind-Value="Options.AmbientLight" Min="0" Max="1" Step="0.01" />
                            <FluentSlider Label="SpecularPower" @bind-Value="Options.SpecularPower" Min="1" Max="100" Step="0.25" />
                            <FluentSelect Items=@_sampleCountItems Label="MSAA Sample Count"
                                          TOption="Option<int>"
                                          OptionText="@(i => i.Text)"
                                          OptionValue="@(i => i.Value.ToString())"
                                          @bind-SelectedOption="@selectedIntOption" ValueChanged="SampleCountOptionChanged" />
                        </FluentAccordionItem>
                    </FluentAccordion>
                    <FluentAccordion>
                        <FluentAccordionItem Heading="📐 Grid">
                            <FluentStack Orientation="Orientation.Vertical">
                                <FluentSlider Label="Coordinate Thickness" @bind-Value="Options.CoordinateThickness" Min="0" Max="10" Step="0.1" />
                                <FluentSlider Label="Grid Size" @bind-Value="Options.GridSize" Min="50" Max="1000" Step="1" />
                                <FluentSlider Label="Grid Spacing" @bind-Value="Options.GridSpacing" Min="1" Max="100" Step="0.5" />
                                <FluentSlider Label="Line Width X" @bind-Value="Options.LineWidthX" Min="0" Max="1" Step="0.01" />
                                <FluentSlider Label="Line Width Y" @bind-Value="Options.LineWidthY" Min="0" Max="1" Step="0.01" />
                                <label>Grid Line Color</label>
                                <input type="color" style="width:100%;" @bind="Options.LineColor" @bind:event="oninput" />
                                <FluentSlider Label="Line Transparency" @bind-Value="Options.LineTransparency" Min="0" Max="1" Step="0.01" />
                                <label>Grid Base Color</label>
                                <input type="color" style="width:100%;" @bind="Options.BaseColor" @bind:event="oninput" />
                                <FluentSlider Label="Base Transparency" @bind-Value="Options.BaseTransparency" Min="0" Max="1" Step="0.01" />
                            </FluentStack>
                        </FluentAccordionItem>
                    </FluentAccordion>
                    <FluentAccordion>
                        <FluentAccordionItem Heading="📷 Camera">
                            <FluentStack Orientation="Orientation.Vertical">
                                <FluentRadioGroup @bind-Value="Options.ZIsUp">
                                    <FluentRadio Value="false">Y is Up</FluentRadio>
                                    <FluentRadio Value="true">Z is Up</FluentRadio>
                                </FluentRadioGroup>
                                <FluentLabel>Which Coordinate is Up?</FluentLabel>
                                <FluentRadioGroup @bind-Value="Options.IsProjectionCamera">
                                    <FluentRadio Value="true">Perspective</FluentRadio>
                                    <FluentRadio Value="false">Orthographic</FluentRadio>
                                </FluentRadioGroup>
                                <FluentLabel>Projection vs Ortho</FluentLabel>

                                <FluentStack>
                                    @if (Options.IsProjectionCamera)
                                    {
                                        <FluentSlider Label="Field of View" @bind-Value="Options.Fov" Min="1" Max="179" Step="0.5" />
                                    }
                                    else
                                    {
                                        <FluentLabel>Orthographic Size: @Options.OrthoSize.ToString("F2")</FluentLabel>
                                        <FluentSlider @bind-Value="Options.OrthoSize" Min="1" Max="999" Step="0.5" />
                                    }
                                </FluentStack>
                                <FluentLabel>Near: @Options.ZNear.ToString("F5")</FluentLabel>
                                <FluentSlider @bind-Value="Options.ZNear" Min="0.00001" Max="1" Step="0.001" />
                                <FluentLabel>Far: @Options.ZFar.ToString("F0")</FluentLabel>
                                <FluentSlider @bind-Value="Options.ZFar" Min="10" Max="9999" Step="1" />
                                <FluentCheckbox @bind-Value="Options.ConstrainPolar" Label="Constrain Polar" />
                                @if (Options.ConstrainPolar)
                                {
                                    <FluentLabel>Max Polar: @((Options.MaxPolar * 180 / Math.PI).ToString("F0"))°</FluentLabel>
                                    <FluentSlider @bind-Value="Options.MaxPolar" Min="0" Max="@(Math.PI * 0.5)" Step="0.01" />
                                    <FluentLabel>Min Polar: @((Options.MinPolar * 180 / Math.PI).ToString("F0"))°</FluentLabel>
                                    <FluentSlider @bind-Value="Options.MinPolar" Min="@(-Math.PI * 0.5)" Max="0" Step="0.01" />
                                }
                                <FluentCheckbox @bind-Value="Options.ConstrainAzimuth" Label="Constrain Azimuth" />
                                @if (Options.ConstrainAzimuth)
                                {
                                    <FluentLabel>Max Azimuth: @((Options.MaxAzimuth * 180 / Math.PI).ToString("F0"))°</FluentLabel>
                                    <FluentSlider @bind-Value="Options.MaxAzimuth" Min="@(-Math.PI)" Max="@Math.PI" Step="0.01" />
                                    <FluentLabel>Min Azimuth: @((Options.MinAzimuth * 180 / Math.PI).ToString("F0"))°</FluentLabel>
                                    <FluentSlider @bind-Value="Options.MinAzimuth" Min="@(-Math.PI)" Max="@Math.PI" Step="0.01" />
                                }
                                <FluentCheckbox @bind-Value="Options.ConstrainDistance" Label="Constrain Distance" />
                                @if (Options.ConstrainDistance)
                                {
                                    <FluentLabel>Max Distance: @Options.MaxDistance.ToString("F1")</FluentLabel>
                                    <FluentSlider @bind-Value="Options.MaxDistance" Min="1" Max="1000" Step="0.5" />
                                    <FluentLabel>Min Distance: @Options.MinDistance.ToString("F2")</FluentLabel>
                                    <FluentSlider @bind-Value="Options.MinDistance" Min="0.1" Max="10" Step="0.1" />
                                }
                                <FluentLabel>Orbit Sensitivity: @Options.OrbitSensitivity.ToString("F5")</FluentLabel>
                                <FluentSlider @bind-Value="Options.OrbitSensitivity" Min="0.001" Max="0.1" Step="0.001" />
                                <FluentLabel>Zoom Sensitivity: @Options.ZoomSensitivity.ToString("F5")</FluentLabel>
                                <FluentSlider @bind-Value="Options.ZoomSensitivity" Min="0.0001" Max="0.01" Step="0.0001" />
                                <FluentLabel>Pan Sensitivity: @Options.PanSensitivity.ToString("F5")</FluentLabel>
                                <FluentSlider @bind-Value="Options.PanSensitivity" Min="0.0001" Max="0.01" Step="0.001" />
                                <FluentLabel>Pan Speed (Shift): @Options.PanSpeedMultiplier.ToString("F1")</FluentLabel>
                                <FluentSlider @bind-Value="Options.PanSpeedMultiplier" Min="1" Max="10" Step="0.5" />
                            </FluentStack>
                        </FluentAccordionItem>
                    </FluentAccordion>
                </FluentStack>
            </div>
        </Body>
    </FluentPopover>
    <FluentPopover AnchorId="help"
                   Style="width:300px;"
                   @bind-Open="_helpPopover"
                   HorizontalPosition="HorizontalPosition.Right">
        <Body>
            <h4>🎮 Camera Controls</h4>
            <div class="control-group">
                <strong>🖱️ Mouse:</strong>
                <ul>
                    <li><strong>Left Drag:</strong> Rotate</li>
                    <li><strong>Right Drag:</strong> Pan</li>
                    <li><strong>Wheel:</strong> Zoom</li>
                    <li><strong>Double-Click:</strong> Pick</li>
                </ul>
            </div>
            <div class="control-group">
                <strong>⌨️ Keyboard:</strong>
                <ul>
                    <li><strong>W/S:</strong> Forward / Back</li>
                    <li><strong>A/D:</strong> Left / Right</li>
                    <li><strong>Q/E:</strong> Down / Up</li>
                    <li><strong>Shift:</strong> Faster</li>
                    <li><strong>.</strong> Toggle Panel</li>
                </ul>
            </div>
        </Body>
    </FluentPopover>

</div>

<style>
    .toolbar-buttons {
        animation: fadeToTransparent 5s ease-in-out forwards;
    }

        .toolbar-buttons:hover:not(.mouse-down),
        .toolbar-buttons.popover-open {
            animation: none;
            opacity: 1 !important;
        }

    @@keyframes fadeToTransparent {
        from {
            opacity: 1;
        }

        to {
            opacity: 0.001;
        }
    }
</style>

